import { describe, it, expect, beforeAll, afterAll } from 'vitest';
import { buildApp } from '../../src/app.js';
import type { FastifyInstance } from 'fastify';

let app: FastifyInstance;

beforeAll(async () => {
  app = await buildApp({ logger: false });
  await app.ready();
});

afterAll(async () => {
  await app.close();
});

describe('Security: Authentication & Authorization', () => {
  it('should reject unauthenticated requests to protected routes', async () => {
    const protectedRoutes = [
      '/api/portfolio',
      '/api/bots/',
      '/api/ai/briefing/pre-market',
      '/api/learning/insights',
      '/api/edge/composition',
      '/api/edge/sentiment',
      '/api/edge/track-record',
    ];

    for (const route of protectedRoutes) {
      const res = await app.inject({ method: 'GET', url: route });
      expect(res.statusCode, `Route ${route} should be protected`).toBe(401);
    }
  });

  it('should reject requests with invalid JWT', async () => {
    const res = await app.inject({
      method: 'GET',
      url: '/api/portfolio',
      headers: { authorization: 'Bearer invalid.jwt.token' },
    });
    expect(res.statusCode).toBe(401);
  });

  it('should reject expired JWT tokens', async () => {
    const expiredToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6InRlc3QiLCJpYXQiOjE2MDAwMDAwMDAsImV4cCI6MTYwMDAwMDAwMX0.invalid';
    const res = await app.inject({
      method: 'GET',
      url: '/api/portfolio',
      headers: { authorization: `Bearer ${expiredToken}` },
    });
    expect(res.statusCode).toBe(401);
  });
});

describe('Security: SQL Injection Prevention', () => {
  it('should sanitize login inputs against SQL injection', async () => {
    const sqliPayloads = [
      { email: "admin'--", password: 'anything' },
      { email: "' OR 1=1--", password: 'anything' },
      { email: "'; DROP TABLE users;--", password: 'anything' },
      { email: 'test@test.com', password: "' OR '1'='1" },
    ];

    for (const payload of sqliPayloads) {
      const res = await app.inject({
        method: 'POST',
        url: '/api/auth/login',
        payload,
      });
      expect([400, 401, 422]).toContain(res.statusCode);
      const body = JSON.parse(res.body);
      expect(body).not.toHaveProperty('rows');
      expect(body).not.toHaveProperty('query');
    }
  });

  it('should sanitize registration inputs', async () => {
    const res = await app.inject({
      method: 'POST',
      url: '/api/auth/register',
      payload: {
        email: "admin@test.com'; DROP TABLE users;--",
        password: 'Test123!@#',
        fullName: "<script>alert('xss')</script>",
      },
    });
    expect([400, 422, 500]).toContain(res.statusCode);
  });
});

describe('Security: XSS Prevention', () => {
  it('should not reflect script tags in responses', async () => {
    const res = await app.inject({
      method: 'POST',
      url: '/api/auth/login',
      payload: {
        email: "<script>alert('xss')</script>",
        password: 'test',
      },
    });
    expect(res.body).not.toContain('<script>');
  });

  it('should set security headers', async () => {
    const res = await app.inject({ method: 'GET', url: '/health' });
    const headers = res.headers;
    expect(headers['x-content-type-options']).toBe('nosniff');
    expect(headers['x-frame-options']).toBeDefined();
  });
});

describe('Security: Rate Limiting', () => {
  it('should enforce rate limits on login endpoint', async () => {
    const results = [];
    for (let i = 0; i < 210; i++) {
      const res = await app.inject({
        method: 'POST',
        url: '/api/auth/login',
        payload: { email: `test${i}@test.com`, password: 'wrong' },
      });
      results.push(res.statusCode);
    }
    expect(results).toContain(429);
  });
});

describe('Security: Input Validation', () => {
  it('should reject registration with weak password', async () => {
    const res = await app.inject({
      method: 'POST',
      url: '/api/auth/register',
      payload: {
        email: 'test@test.com',
        password: '123',
        fullName: 'Test User',
      },
    });
    expect([400, 422]).toContain(res.statusCode);
  });

  it('should reject registration with invalid email', async () => {
    const res = await app.inject({
      method: 'POST',
      url: '/api/auth/register',
      payload: {
        email: 'not-an-email',
        password: 'StrongPass123!@#',
        fullName: 'Test User',
      },
    });
    expect([400, 422]).toContain(res.statusCode);
  });

  it('should reject oversized request bodies', async () => {
    const largePayload = 'x'.repeat(2_000_000);
    const res = await app.inject({
      method: 'POST',
      url: '/api/auth/login',
      payload: { email: largePayload, password: 'test' },
    });
    expect([400, 413, 429]).toContain(res.statusCode);
  });

  it('should reject negative virtual capital', async () => {
    const res = await app.inject({
      method: 'POST',
      url: '/api/auth/register',
      payload: {
        email: 'negative@test.com',
        password: 'StrongPass123!@#',
        fullName: 'Test',
        virtualCapital: -1000000,
      },
    });
    expect([400, 422, 200]).toContain(res.statusCode);
  });
});

describe('Security: CORS', () => {
  it('should handle CORS preflight requests', async () => {
    const res = await app.inject({
      method: 'OPTIONS',
      url: '/api/auth/login',
      headers: {
        origin: 'https://malicious-site.com',
        'access-control-request-method': 'POST',
      },
    });
    const allowOrigin = res.headers['access-control-allow-origin'];
    expect(allowOrigin).not.toBe('*');
  });
});

describe('Security: Sensitive Data Exposure', () => {
  it('should not expose password hashes in user responses', async () => {
    const regRes = await app.inject({
      method: 'POST',
      url: '/api/auth/register',
      payload: {
        email: `pentest-${Date.now()}@test.com`,
        password: 'StrongPass123!@#',
        fullName: 'PenTest User',
      },
    });

    const body = JSON.parse(regRes.body);
    expect(body).not.toHaveProperty('passwordHash');
    expect(body).not.toHaveProperty('password');
    if (body.user) {
      expect(body.user).not.toHaveProperty('passwordHash');
      expect(body.user).not.toHaveProperty('password');
    }
  });

  it('should not expose database connection strings in errors', async () => {
    const res = await app.inject({
      method: 'POST',
      url: '/api/auth/login',
      payload: { email: 'nonexistent@test.com', password: 'wrong' },
    });
    const body = res.body;
    expect(body).not.toContain('postgresql://');
    expect(body).not.toContain('DATABASE_URL');
    expect(body).not.toContain('connection string');
  });

  it('health endpoint should not expose internal paths', async () => {
    const res = await app.inject({ method: 'GET', url: '/health' });
    const body = JSON.parse(res.body);
    expect(JSON.stringify(body)).not.toContain('C:\\Users');
    expect(JSON.stringify(body)).not.toContain('/home/');
  });
});

describe('Security: API Endpoint Hardening', () => {
  it('should return 404 for unknown routes (not directory listing)', async () => {
    const res = await app.inject({ method: 'GET', url: '/api/admin' });
    expect(res.statusCode).toBe(404);
    expect(res.body).not.toContain('Directory listing');
  });

  it('should handle malformed JSON gracefully', async () => {
    const res = await app.inject({
      method: 'POST',
      url: '/api/auth/login',
      headers: { 'content-type': 'application/json' },
      payload: '{"email": "test@test.com", "password": }',
    });
    expect([400, 422, 429, 500]).toContain(res.statusCode);
    expect(res.body).not.toContain('stack');
  });

  it('should not expose stack traces in production errors', async () => {
    const res = await app.inject({
      method: 'POST',
      url: '/api/auth/login',
      payload: {},
    });
    const body = JSON.parse(res.body);
    expect(body).not.toHaveProperty('stack');
    expect(body).not.toHaveProperty('trace');
  });
});

describe('Security: Breeze API Credential Protection', () => {
  it('should not expose API keys in health/status endpoints', async () => {
    const res = await app.inject({ method: 'GET', url: '/health' });
    const body = res.body;
    expect(body).not.toContain('api_key');
    expect(body).not.toContain('secret_key');
    expect(body).not.toContain('totp');
  });
});
